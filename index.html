<!DOCTYPE html>
<html lang="fi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sumu Teksti-TV</title>
<style>
body {
  background: black;
  color: white;
  font-family: "Courier New", monospace;
  font-size: 18px;
  text-align: center;
  margin: 0;
  padding: 0;
}
#view {
  white-space: pre;
  text-align: left;
  margin: 20px auto;
  width: 40ch;
  background: black;
  padding: 10px;
  border: 2px solid #555;
  min-height: 480px;
}
#status {
  color: #0f0;
  font-size: 14px;
  margin-top: 5px;
}
#numPad {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 5px;
  width: 200px;
  margin: 15px auto;
}
#numPad button {
  background: #222;
  color: #fff;
  font-size: 18px;
  border: 1px solid #555;
  border-radius: 4px;
  padding: 10px;
}
#numPad button:hover {
  background: #444;
}
</style>
</head>
<body>

<h2>Sumu Teksti-TV</h2>
<div id="view">Ladataan...</div>
<div id="status"></div>

<div>
  Syötä 3 numeroa (esim. 100, 500, 600, 800)
  <br>
  <input type="text" id="input" maxlength="3" style="text-align:center;font-size:18px;width:60px;margin-top:5px;">
  <button onclick="goToPage()">OK</button>
</div>

<div id="numPad">
  <button onclick="num(1)">1</button>
  <button onclick="num(2)">2</button>
  <button onclick="num(3)">3</button>
  <button onclick="num(4)">4</button>
  <button onclick="num(5)">5</button>
  <button onclick="num(6)">6</button>
  <button onclick="num(7)">7</button>
  <button onclick="num(8)">8</button>
  <button onclick="num(9)">9</button>
  <button onclick="clr()">C</button>
  <button onclick="num(0)">0</button>
  <button onclick="goToPage()">OK</button>
</div>

<script>
const view = document.getElementById("view");
const input = document.getElementById("input");
const statusEl = document.getElementById("status");

const pages = {
  100: "100.tti",
  101: "101.tti",
  500: "500.tti",
  600: "600.tti",
  800: "800.tti"
};

function setStatus(msg){ statusEl.textContent = msg; }

function num(n){
  if(input.value.length < 3) input.value += n;
}

function clr(){ input.value = ""; }

function goToPage(){
  const n = parseInt(input.value);
  if(isNaN(n)) return;
  loadPage(n);
  clr();
}

async function loadPage(n){
  const num = String(n);
  if(!pages[n]){ 
    setStatus(`Sivua ${num} ei ole (vielä).`); 
    view.textContent = `Virhe: sivua ${num} ei löytynyt.`;
    return; 
  }
  setStatus(`Ladataan sivua ${num}...`);
  try{
    const res = await fetch(pages[n], {cache: "no-store"});
    if(!res.ok) throw new Error(res.status + " " + res.statusText);
    const raw = await res.text();
    const rendered = renderTTI(raw);
    view.textContent = rendered;
    setStatus(`Sivu ${num} ladattu.`);
  }catch(e){
    view.textContent = `Virhe ladattaessa sivua ${num}:\n${e.message}`;
    setStatus(`Virhe sivulla ${num}.`);
  }
}

function renderTTI(raw){
  const rows = Array.from({length:24}, ()=> "");
  const lines = raw.replace(/\r\n/g,"\n").split("\n");

  // Teletextin suomi/ruotsi -merkistömuunnos
  const map = {
    "[":"Ä","\\":"Ö","]":"Å",
    "{":"ä","|":"ö","}":"å"
  };
  const xlat = s => s.replace(/[\[\]\\\]\{\|\}]/g, ch => map[ch] || ch);

  for(const line of lines){
    if(line.startsWith("OL,")){
      const parts = line.split(",");
      if(parts.length >= 3){
        const rowNum = parseInt(parts[1],10);
        let text = parts.slice(2).join(",");
        text = text.replace(/\x1b\[[0-9;]*m/g,"");
        text = xlat(text);
        if(rowNum>=1 && rowNum<=24){
          rows[rowNum-1] = text;
        }
      }
    }
  }
  return rows.map(r => r.padEnd(40," ")).join("\n");
}

// Ladataan etusivu heti
loadPage(100);
</script>

</body>
</html>
